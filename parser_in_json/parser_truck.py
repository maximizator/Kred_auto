import requests
import time
import json
from xml.etree import ElementTree as ET

url = "https://z34.ru/xml/gruz?h=65ee9f149fd78bb1c186ed11380cf06cd7dfd6b0"
–∏–º—è_—Ñ–∞–π–ª–∞ = "../data/truck.json"

print("–û–±–Ω–æ–≤–ª—è—é")

while True:
    try:
        # 1. –ò–¥—ë–º –∑–∞ XML
        –æ—Ç–≤–µ—Ç = requests.get(url, timeout=5)
        if –æ—Ç–≤–µ—Ç.status_code != 200:
            print("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", –æ—Ç–≤–µ—Ç.status_code)
            time.sleep(2)
            continue

        # 2. –ë–µ—Ä—ë–º –ö–û–†–ï–ù–¨ ‚Äî –≤—Å—é –∫–æ—Ä–æ–±–∫—É —Ü–µ–ª–∏–∫–æ–º üì¶
        –∫–æ—Ä–µ–Ω—å = ET.fromstring(–æ—Ç–≤–µ—Ç.content)

        # 3. –°–æ–±–∏—Ä–∞–µ–º —à–∏–Ω—ã –ü–û –ö–û–†–û–ë–ö–ê–ú <–ì—Ä—É–∑_–®–∏–Ω–∞>
        –≤—Å–µ_—à–∏–Ω—ã = []
        for –∫–æ—Ä–æ–±–∫–∞_—à–∏–Ω—ã in –∫–æ—Ä–µ–Ω—å.findall(".//–ì—Ä—É–∑_–®–∏–Ω–∞"):
            —à–∏–Ω–∞ = {}
            for —ç–ª–µ–º–µ–Ω—Ç in –∫–æ—Ä–æ–±–∫–∞_—à–∏–Ω—ã.iter():
                if —ç–ª–µ–º–µ–Ω—Ç.text and —ç–ª–µ–º–µ–Ω—Ç.text.strip():
                    —Ç–µ–≥ = —ç–ª–µ–º–µ–Ω—Ç.tag
                    –∑–Ω–∞—á–µ–Ω–∏–µ = —ç–ª–µ–º–µ–Ω—Ç.text.strip()

                    # ‚ú® –ï—Å–ª–∏ —Ü–µ–Ω–∞ ‚Äî —É–º–Ω–æ–∂–∞–µ–º –∏ –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ü–µ–ª–æ–≥–æ
                    if —Ç–µ–≥ == "–¶–µ–Ω–∞":
                        try:
                            —á–∏—Å–ª–æ = float(–∑–Ω–∞—á–µ–Ω–∏–µ.replace(" ", "").replace(",", "."))
                            –∑–Ω–∞—á–µ–Ω–∏–µ = round(—á–∏—Å–ª–æ * 1.15)
                        except:
                            pass  # –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –Ω–µ —á–∏—Å–ª–æ

                    —à–∏–Ω–∞[—Ç–µ–≥] = –∑–Ω–∞—á–µ–Ω–∏–µ
            –≤—Å–µ_—à–∏–Ω—ã.append(—à–∏–Ω–∞)

        # –®–∞–≥ 4: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –û–î–ò–ù —Ñ–∞–π–ª (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º)
        with open(–∏–º—è_—Ñ–∞–π–ª–∞, "w", encoding="utf-8") as f:
            json.dump(–≤—Å–µ_—à–∏–Ω—ã, f, ensure_ascii=False, indent=2)

        print(f"‚úÖ –ó–∞–ø–∏—Å–∞–ª {len(–≤—Å–µ_—à–∏–Ω—ã)} —à—Ç. –≤ {–∏–º—è_—Ñ–∞–π–ª–∞}")

    except Exception as e:
        print("‚ö†Ô∏è –û—à–∏–±–∫–∞:", str(e))